@model PerfumeStore.Areas.Admin.Models.Warranty
@{
    ViewData["Title"] = "Tạo bảo hành mới";
}

<div class="d-flex align-items-center mb-4">
    <a asp-action="Index" class="btn btn-outline-secondary me-3">
        <i class="fas fa-arrow-left"></i>
    </a>
    <h4 class="mb-0">
        <i class="fas fa-plus-circle me-2 text-success"></i>Tạo bảo hành mới
    </h4>
</div>

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2 text-primary"></i>Thông tin bảo hành
                </h6>
            </div>
            <div class="card-body">
                <form asp-action="Create" method="post" id="warrantyForm">
                    <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>
                    
                    @* Hidden field để tránh lỗi validation cho WarrantyCode (sẽ được tạo tự động trong Controller) *@
                    <input type="hidden" asp-for="WarrantyCode" value="TEMP" />
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label asp-for="OrderDetailId" class="form-label fw-semibold">
                                <i class="fas fa-shopping-cart me-1 text-primary"></i>Chi tiết đơn hàng
                                <span class="text-danger">*</span>
                            </label>
                            <select asp-for="OrderDetailId" class="form-select" required>
                                <option value="">-- Chọn chi tiết đơn hàng --</option>
                                @if (ViewBag.OrderDetails != null)
                                {
                                    @foreach (var od in (List<PerfumeStore.Areas.Admin.Models.OrderDetail>)ViewBag.OrderDetails)
                                    {
                                        var productName = od.Product?.ProductName ?? "Không xác định";
                                        var customerName = od.Order?.Customer?.Name ?? "Không xác định";
                                        var orderDate = od.Order?.OrderDate.HasValue == true ? od.Order.OrderDate.Value.ToString("dd/MM/yyyy") : "";
                                        <option value="@od.OrderDetailId" 
                                                data-customer-id="@(od.Order?.CustomerId ?? 0)"
                                                data-product-name="@productName">
                                            @productName - KH: @customerName - Ngày: @orderDate (ID: @od.OrderDetailId)
                                        </option>
                                    }
                                }
                            </select>
                            <span asp-validation-for="OrderDetailId" class="text-danger small"></span>
                            <small class="form-text text-muted">Chỉ hiển thị các chi tiết đơn hàng chưa có bảo hành</small>
                        </div>
                        
                        <div class="col-md-6">
                            <label asp-for="CustomerId" class="form-label fw-semibold">
                                <i class="fas fa-user me-1 text-info"></i>Khách hàng
                                <span class="text-danger">*</span>
                            </label>
                            <select asp-for="CustomerId" class="form-select" required>
                                <option value="">-- Chọn khách hàng --</option>
                                @if (ViewBag.Customers != null)
                                {
                                    @foreach (var customer in (List<PerfumeStore.Areas.Admin.Models.Customer>)ViewBag.Customers)
                                    {
                                        <option value="@customer.CustomerId">@(customer.Name ?? "Không có tên") (@customer.Email)</option>
                                    }
                                }
                            </select>
                            <span asp-validation-for="CustomerId" class="text-danger small"></span>
                        </div>
                        
                        <div class="col-md-4">
                            <label asp-for="StartDate" class="form-label fw-semibold">
                                <i class="fas fa-calendar-alt me-1 text-info"></i>Ngày bắt đầu
                                <span class="text-danger">*</span>
                            </label>
                            <input asp-for="StartDate" type="datetime-local" class="form-control" required />
                            <span asp-validation-for="StartDate" class="text-danger small"></span>
                        </div>
                        
                        <div class="col-md-4">
                            <label asp-for="EndDate" class="form-label fw-semibold">
                                <i class="fas fa-calendar-times me-1 text-warning"></i>Ngày kết thúc
                            </label>
                            <input asp-for="EndDate" type="datetime-local" class="form-control" />
                            <span asp-validation-for="EndDate" class="text-danger small"></span>
                            <small class="form-text text-muted">Để trống nếu muốn tính tự động từ thời gian bảo hành</small>
                        </div>
                        
                        <div class="col-md-4">
                            <label asp-for="WarrantyPeriodMonths" class="form-label fw-semibold">
                                <i class="fas fa-clock me-1 text-secondary"></i>Thời gian bảo hành (tháng)
                                <span class="text-danger">*</span>
                            </label>
                            <input asp-for="WarrantyPeriodMonths" type="number" class="form-control" min="1" max="60" required />
                            <span asp-validation-for="WarrantyPeriodMonths" class="text-danger small"></span>
                        </div>
                        
                        <div class="col-md-6">
                            <label asp-for="Status" class="form-label fw-semibold">
                                <i class="fas fa-flag me-1 text-success"></i>Trạng thái
                                <span class="text-danger">*</span>
                            </label>
                            <select asp-for="Status" class="form-select" required>
                                <option value="Active">Đang hoạt động</option>
                                <option value="Expired">Hết hạn</option>
                                <option value="Cancelled">Đã hủy</option>
                            </select>
                            <span asp-validation-for="Status" class="text-danger small"></span>
                        </div>
                        
                        <div class="col-12">
                            <label asp-for="Notes" class="form-label fw-semibold">
                                <i class="fas fa-sticky-note me-1 text-warning"></i>Ghi chú
                            </label>
                            <textarea asp-for="Notes" class="form-control" rows="3" placeholder="Nhập ghi chú về bảo hành..."></textarea>
                            <span asp-validation-for="Notes" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="d-flex gap-2 justify-content-end mt-4">
                        <a asp-action="Index" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Hủy
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-save me-1"></i>
                            <span class="btn-text">Tạo bảo hành</span>
                            <span class="btn-loading d-none">
                                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                                Đang xử lý...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        // Auto-fill customer when order detail is selected
        document.getElementById('OrderDetailId').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                const customerId = selectedOption.getAttribute('data-customer-id');
                if (customerId && customerId !== '0') {
                    document.getElementById('CustomerId').value = customerId;
                }
            }
        });

        // Auto-calculate end date when period changes
        document.getElementById('WarrantyPeriodMonths').addEventListener('change', function() {
            const startDate = new Date(document.getElementById('StartDate').value);
            const months = parseInt(this.value);
            
            if (startDate && !isNaN(startDate.getTime()) && months > 0) {
                const endDate = new Date(startDate);
                endDate.setMonth(endDate.getMonth() + months);
                
                // Format for datetime-local input
                const formattedEndDate = endDate.toISOString().slice(0, 16);
                const endDateInput = document.getElementById('EndDate');
                if (!endDateInput.value) {
                    endDateInput.value = formattedEndDate;
                }
            }
        });

        // Auto-calculate period when dates change
        function calculatePeriod() {
            const startDate = new Date(document.getElementById('StartDate').value);
            const endDate = new Date(document.getElementById('EndDate').value);
            
            if (startDate && endDate && !isNaN(startDate.getTime()) && !isNaN(endDate.getTime()) && endDate > startDate) {
                const diffTime = Math.abs(endDate - startDate);
                const diffMonths = Math.ceil(diffTime / (1000 * 60 * 60 * 24 * 30));
                document.getElementById('WarrantyPeriodMonths').value = diffMonths;
            }
        }

        document.getElementById('StartDate').addEventListener('change', calculatePeriod);
        document.getElementById('EndDate').addEventListener('change', calculatePeriod);

        // Handle form submission
        document.getElementById('warrantyForm').addEventListener('submit', function(e) {
            const submitBtn = document.getElementById('submitBtn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');
            
            // Disable submit button and show loading
            submitBtn.disabled = true;
            btnText.classList.add('d-none');
            btnLoading.classList.remove('d-none');
            
            // Validate required fields
            const orderDetailId = document.getElementById('OrderDetailId').value;
            const customerId = document.getElementById('CustomerId').value;
            const startDate = document.getElementById('StartDate').value;
            const warrantyPeriod = document.getElementById('WarrantyPeriodMonths').value;
            
            if (!orderDetailId || !customerId || !startDate || !warrantyPeriod) {
                e.preventDefault();
                alert('Vui lòng điền đầy đủ các trường bắt buộc!');
                submitBtn.disabled = false;
                btnText.classList.remove('d-none');
                btnLoading.classList.add('d-none');
                return false;
            }
            
            // Auto-calculate EndDate if not provided
            const endDate = document.getElementById('EndDate').value;
            if (!endDate && startDate && warrantyPeriod) {
                const start = new Date(startDate);
                const months = parseInt(warrantyPeriod);
                if (!isNaN(start.getTime()) && months > 0) {
                    const calculatedEnd = new Date(start);
                    calculatedEnd.setMonth(calculatedEnd.getMonth() + months);
                    document.getElementById('EndDate').value = calculatedEnd.toISOString().slice(0, 16);
                }
            }
        });
    </script>
}

<style>
.card {
    border-radius: 12px;
}

.card-header {
    border-radius: 12px 12px 0 0 !important;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
}

@@media (max-width: 768px) {
    .col-lg-10 {
        padding: 0 15px;
    }
}
</style>

