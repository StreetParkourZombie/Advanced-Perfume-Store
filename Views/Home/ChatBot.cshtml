@{
    ViewData["Title"] = "PerfumeBot Demo";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">ü§ñ PerfumeBot - Tr·ª£ l√Ω ·∫£o PerfumeStore</h5>
                </div>
                <div class="card-body" style="height: 400px; overflow-y: auto;" id="chatMessages">
                    <div class="alert alert-info">
                        <strong>PerfumeBot:</strong> Ch√†o b·∫°n! üëã M√¨nh l√† PerfumeBot, tr·ª£ l√Ω ·∫£o c·ªßa PerfumeStore. M√¨nh c√≥ th·ªÉ gi√∫p b·∫°n:
                        <br>üå∏ T∆∞ v·∫•n n∆∞·ªõc hoa ph√π h·ª£p
                        <br>üì¶ Ki·ªÉm tra ƒë∆°n h√†ng  
                        <br>üí≥ Th√¥ng tin ch√≠nh s√°ch
                        <br><br>B·∫°n c·∫ßn h·ªó tr·ª£ g√¨ nh√©?
                    </div>
                </div>
                <div class="card-footer">
                    <div class="input-group">
                        <input type="text" class="form-control" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="handleKeyPress(event)">
                        <button class="btn btn-primary" onclick="sendMessage()">G·ª≠i</button>
                    </div>
                    <small class="text-muted mt-2 d-block">
                        API Key: <input type="text" id="apiKeyInput" class="form-control form-control-sm mt-1" placeholder="Nh·∫≠p API key ƒë·ªÉ test">
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

async function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const chatMessages = document.getElementById('chatMessages');
    
    const message = messageInput.value.trim();
    const apiKey = apiKeyInput.value.trim();
    
    if (!message) return;
    if (!apiKey) {
        alert('Vui l√≤ng nh·∫≠p API key ƒë·ªÉ test!');
        return;
    }
    
    // Hi·ªÉn th·ªã tin nh·∫Øn ng∆∞·ªùi d√πng
    addMessage('B·∫°n', message, 'user');
    messageInput.value = '';
    
    // Hi·ªÉn th·ªã loading
    const loadingId = addMessage('PerfumeBot', 'ƒêang suy nghƒ©...', 'bot');
    
    try {
        const response = await fetch('/api/ChatBot/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-API-Key': apiKey
            },
            body: JSON.stringify({
                message: message,
                userId: 'demo-user'
            })
        });
        
        const data = await response.json();
        
        // X√≥a loading v√† hi·ªÉn th·ªã ph·∫£n h·ªìi
        document.getElementById(loadingId).remove();
        
        if (response.ok) {
            addMessage('PerfumeBot', data.message, 'bot');
        } else {
            addMessage('PerfumeBot', data.error || 'C√≥ l·ªói x·∫£y ra', 'bot error');
        }
    } catch (error) {
        document.getElementById(loadingId).remove();
        addMessage('PerfumeBot', 'L·ªói k·∫øt n·ªëi: ' + error.message, 'bot error');
    }
}

function addMessage(sender, message, type) {
    const chatMessages = document.getElementById('chatMessages');
    const messageId = 'msg-' + Date.now();
    
    let alertClass = 'alert-secondary';
    if (type === 'user') alertClass = 'alert-primary';
    else if (type === 'bot') alertClass = 'alert-success';
    else if (type === 'bot error') alertClass = 'alert-danger';
    
    const messageDiv = document.createElement('div');
    messageDiv.id = messageId;
    messageDiv.className = `alert ${alertClass} mb-2`;
    messageDiv.innerHTML = `<strong>${sender}:</strong> ${message.replace(/\n/g, '<br>')}`;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    return messageId;
}
</script>

<style>
.alert {
    margin-bottom: 0.5rem;
}
.alert-primary {
    text-align: right;
}
</style>