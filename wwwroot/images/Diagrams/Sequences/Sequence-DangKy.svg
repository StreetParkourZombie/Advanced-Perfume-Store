<?xml version="1.0" encoding="UTF-8"?>
<svg width="1400" height="1200" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .actor { fill: #E8F4F8; stroke: #2E5C8A; stroke-width: 2; }
      .lifeline { stroke: #666; stroke-width: 1; stroke-dasharray: 5,5; }
      .message { stroke: #333; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .self-message { stroke: #333; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .activation { fill: #4A90E2; opacity: 0.3; }
      .text { font-family: Arial, sans-serif; font-size: 12px; }
      .text-small { font-family: Arial, sans-serif; font-size: 10px; }
      .text-bold { font-family: Arial, sans-serif; font-size: 12px; font-weight: bold; }
      .alt-box { fill: #FFF9E6; stroke: #D68910; stroke-width: 2; stroke-dasharray: 5,5; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#333" />
    </marker>
  </defs>
  
  <!-- Title -->
  <text x="700" y="30" font-family="Arial" font-size="18" font-weight="bold" text-anchor="middle">Sequence Diagram: Đăng Ký Tài Khoản</text>
  
  <!-- Actors -->
  <rect x="50" y="60" width="120" height="60" class="actor" rx="5"/>
  <text x="110" y="85" class="text-bold" text-anchor="middle">Người dùng</text>
  <text x="110" y="100" class="text-small" text-anchor="middle">(User)</text>
  
  <rect x="250" y="60" width="120" height="60" class="actor" rx="5"/>
  <text x="310" y="85" class="text-bold" text-anchor="middle">Web Application</text>
  <text x="310" y="100" class="text-small" text-anchor="middle">(AuthController)</text>
  
  <rect x="450" y="60" width="120" height="60" class="actor" rx="5"/>
  <text x="510" y="85" class="text-bold" text-anchor="middle">Database</text>
  <text x="510" y="100" class="text-small" text-anchor="middle">(PerfumeStoreContext)</text>
  
  <rect x="650" y="60" width="120" height="60" class="actor" rx="5"/>
  <text x="710" y="85" class="text-bold" text-anchor="middle">Email Service</text>
  <text x="710" y="100" class="text-small" text-anchor="middle">(IEmailService)</text>
  
  <!-- Lifelines -->
  <line x1="110" y1="120" x2="110" y2="1100" class="lifeline"/>
  <line x1="310" y1="120" x2="310" y2="1100" class="lifeline"/>
  <line x1="510" y1="120" x2="510" y2="1100" class="lifeline"/>
  <line x1="710" y1="120" x2="710" y2="1100" class="lifeline"/>
  
  <!-- Sequence -->
  <!-- Step 1: User requests registration page -->
  <line x1="110" y1="150" x2="310" y2="150" class="message"/>
  <text x="210" y="145" class="text-small">GET /Auth/Register</text>
  
  <rect x="270" y="140" width="80" height="20" class="activation"/>
  
  <line x1="310" y1="160" x2="110" y2="160" class="message" stroke-dasharray="5,5"/>
  <text x="210" y="165" class="text-small">Hiển thị form đăng ký</text>
  
  <!-- Step 2: User submits registration form -->
  <line x1="110" y1="200" x2="310" y2="200" class="message"/>
  <text x="210" y="195" class="text-small">POST /Auth/Register</text>
  <text x="210" y="205" class="text-small">(name, email, password, phone)</text>
  
  <rect x="270" y="190" width="80" height="20" class="activation"/>
  
  <!-- Step 3: Validate input -->
  <line x1="310" y1="220" x2="310" y2="240" class="self-message"/>
  <text x="320" y="230" class="text-small">Validate thông tin</text>
  
  <!-- Step 4: Check if email exists -->
  <line x1="310" y1="260" x2="510" y2="260" class="message"/>
  <text x="410" y="255" class="text-small">Kiểm tra email đã tồn tại?</text>
  
  <rect x="470" y="250" width="80" height="20" class="activation"/>
  
  <line x1="510" y1="270" x2="310" y2="270" class="message" stroke-dasharray="5,5"/>
  <text x="410" y="275" class="text-small">Trả về kết quả</text>
  
  <!-- Alt: Email exists -->
  <rect x="40" y="300" width="1320" height="80" class="alt-box"/>
  <text x="50" y="320" class="text-bold">[Email đã tồn tại]</text>
  
  <line x1="310" y1="330" x2="110" y2="330" class="message" stroke-dasharray="5,5"/>
  <text x="210" y="325" class="text-small">Hiển thị lỗi: "Email đã được sử dụng"</text>
  
  <!-- Alt: Check recent pending registration -->
  <rect x="40" y="400" width="1320" height="100" class="alt-box"/>
  <text x="50" y="420" class="text-bold">[Email chưa tồn tại - Kiểm tra pending registration]</text>
  
  <line x1="310" y1="440" x2="510" y2="440" class="message"/>
  <text x="410" y="435" class="text-small">Kiểm tra pending registration</text>
  <text x="410" y="445" class="text-small">trong 5 phút gần đây</text>
  
  <rect x="470" y="430" width="80" height="20" class="activation"/>
  
  <line x1="510" y1="450" x2="310" y2="450" class="message" stroke-dasharray="5,5"/>
  <text x="410" y="455" class="text-small">Trả về kết quả</text>
  
  <!-- Alt: Recent pending exists -->
  <rect x="40" y="520" width="1320" height="60" class="alt-box"/>
  <text x="50" y="540" class="text-bold">[Có pending registration gần đây]</text>
  
  <line x1="310" y1="560" x2="110" y2="560" class="message" stroke-dasharray="5,5"/>
  <text x="210" y="555" class="text-small">Thông báo: "Vui lòng kiểm tra email"</text>
  
  <!-- Alt: No blocking issues - Continue registration -->
  <rect x="40" y="600" width="1320" height="480" class="alt-box"/>
  <text x="50" y="620" class="text-bold">[Không có vấn đề - Tiếp tục đăng ký]</text>
  
  <!-- Step 5: Clean expired pending registrations -->
  <line x1="310" y1="650" x2="510" y2="650" class="message"/>
  <text x="410" y="645" class="text-small">Xóa pending registrations</text>
  <text x="410" y="655" class="text-small">đã hết hạn</text>
  
  <rect x="470" y="640" width="80" height="20" class="activation"/>
  
  <line x1="510" y1="660" x2="310" y2="660" class="message" stroke-dasharray="5,5"/>
  <text x="410" y="665" class="text-small">Đã xóa</text>
  
  <!-- Step 6: Generate token and hash password -->
  <line x1="310" y1="690" x2="310" y2="710" class="self-message"/>
  <text x="320" y="700" class="text-small">Tạo token (GUID)</text>
  <text x="320" y="710" class="text-small">Hash password (BCrypt)</text>
  
  <!-- Step 7: Create PendingRegistration -->
  <line x1="310" y1="730" x2="510" y2="730" class="message"/>
  <text x="410" y="725" class="text-small">Tạo PendingRegistration</text>
  <text x="410" y="735" class="text-small">(name, email, passwordHash, token)</text>
  
  <rect x="470" y="720" width="80" height="20" class="activation"/>
  
  <line x1="510" y1="740" x2="310" y2="740" class="message" stroke-dasharray="5,5"/>
  <text x="410" y="745" class="text-small">Đã lưu</text>
  
  <!-- Step 8: Generate callback URL -->
  <line x1="310" y1="770" x2="310" y2="790" class="self-message"/>
  <text x="320" y="780" class="text-small">Tạo callback URL</text>
  <text x="320" y="790" class="text-small">/Auth/ConfirmEmail?token=...</text>
  
  <!-- Step 9: Send verification email -->
  <line x1="310" y1="810" x2="710" y2="810" class="message"/>
  <text x="510" y="805" class="text-small">SendVerificationEmailAsync</text>
  <text x="510" y="815" class="text-small">(email, token, callbackUrl)</text>
  
  <rect x="670" y="800" width="80" height="20" class="activation"/>
  
  <line x1="710" y1="820" x2="310" y2="820" class="message" stroke-dasharray="5,5"/>
  <text x="510" y="825" class="text-small">Email đã gửi</text>
  
  <!-- Step 10: Return success message -->
  <line x1="310" y1="850" x2="110" y2="850" class="message" stroke-dasharray="5,5"/>
  <text x="210" y="845" class="text-small">Thông báo: "Vui lòng kiểm tra email</text>
  <text x="210" y="855" class="text-small">để xác thực (24 giờ)"</text>
  
  <!-- Step 11: User clicks email link -->
  <line x1="110" y1="920" x2="310" y2="920" class="message"/>
  <text x="210" y="915" class="text-small">GET /Auth/ConfirmEmail</text>
  <text x="210" y="925" class="text-small">?token=...</text>
  
  <rect x="270" y="910" width="80" height="20" class="activation"/>
  
  <!-- Step 12: Validate token -->
  <line x1="310" y1="950" x2="510" y2="950" class="message"/>
  <text x="410" y="945" class="text-small">Tìm PendingRegistration</text>
  <text x="410" y="955" class="text-small">theo token</text>
  
  <rect x="470" y="940" width="80" height="20" class="activation"/>
  
  <line x1="510" y1="960" x2="310" y2="960" class="message" stroke-dasharray="5,5"/>
  <text x="410" y="965" class="text-small">Trả về PendingRegistration</text>
  
  <!-- Alt: Token invalid or expired -->
  <rect x="40" y="990" width="1320" height="60" class="alt-box"/>
  <text x="50" y="1010" class="text-bold">[Token không hợp lệ hoặc hết hạn]</text>
  
  <line x1="310" y1="1030" x2="110" y2="1030" class="message" stroke-dasharray="5,5"/>
  <text x="210" y="1025" class="text-small">Hiển thị lỗi</text>
  
  <!-- Alt: Token valid - Create customer -->
  <rect x="40" y="1070" width="1320" height="30" class="alt-box"/>
  <text x="50" y="1090" class="text-bold">[Token hợp lệ - Tạo Customer]</text>
  
  <!-- Step 13: Create Customer -->
  <line x1="310" y1="1110" x2="510" y2="1110" class="message"/>
  <text x="410" y="1105" class="text-small">Tạo Customer mới</text>
  <text x="410" y="1115" class="text-small">Đánh dấu PendingRegistration</text>
  <text x="410" y="1125" class="text-small">IsProcessed = true</text>
  
  <rect x="470" y="1100" width="80" height="30" class="activation"/>
  
  <line x1="510" y1="1130" x2="310" y2="1130" class="message" stroke-dasharray="5,5"/>
  <text x="410" y="1135" class="text-small">Đã tạo Customer</text>
  
  <!-- Step 14: Return success -->
  <line x1="310" y1="1150" x2="110" y2="1150" class="message" stroke-dasharray="5,5"/>
  <text x="210" y="1145" class="text-small">Hiển thị: "Xác thực thành công!"</text>
  <text x="210" y="1155" class="text-small">Link đăng nhập</text>
  
  <!-- End activations -->
  <rect x="270" y="140" width="80" height="20" fill="white" opacity="0"/>
  <rect x="270" y="190" width="80" height="660" fill="white" opacity="0"/>
  <rect x="470" y="250" width="80" height="20" fill="white" opacity="0"/>
  <rect x="470" y="430" width="80" height="20" fill="white" opacity="0"/>
  <rect x="470" y="640" width="80" height="20" fill="white" opacity="0"/>
  <rect x="470" y="720" width="80" height="20" fill="white" opacity="0"/>
  <rect x="670" y="800" width="80" height="20" fill="white" opacity="0"/>
  <rect x="270" y="910" width="80" height="240" fill="white" opacity="0"/>
  <rect x="470" y="940" width="80" height="30" fill="white" opacity="0"/>
  <rect x="470" y="1100" width="80" height="30" fill="white" opacity="0"/>
</svg>


